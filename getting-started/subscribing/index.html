<!DOCTYPE html>
<html lang="en">
  
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Typelevel Laika + Helium Theme" />
  <title>Receiving Data</title>
  
  <meta name="author" content="fs2-queues contributors"/>
  
  
  <meta name="description" content="docs"/>
  
  
  
  <link rel="icon" sizes="32x32" type="image/png" href="../../favicon-32x32.png"/>
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:500">
  
  <link rel="stylesheet" type="text/css" href="../../helium/site/icofont.min.css" />
    <link rel="stylesheet" type="text/css" href="../../helium/site/laika-helium.css" />
  <script src="../../helium/site/laika-helium.js"></script>
  
  
  <script> /* for avoiding page load transitions */ </script>
</head>

  <body>

    <header id="top-bar" class="light-default dark-default">

  <div class="row">
    <a id="nav-icon">
      <i class="icofont-laika navigationMenu" title="Navigation">&#xefa2;</i>
    </a>
    
    
  </div>

  <a class="text-link" href="../../">fs2-queues</a>

  <div class="row links">
    
    <a class="icon-link svg-link" href="https://www.javadoc.io/doc/com.commercetools/fs2-queues-docs_2.13/0.5.0/com/commercetools/queue/index.html"><span class="api" title="API"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M75,47.5c13.246,0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm-50,-0c13.246,-0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,-0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm2.705,16.735l7.239,0l0.622,-4.904l-21.833,0l-0,4.904l7.589,0l0,22.067l6.383,0l-0,-22.067Zm58.076,7.265c-0,-8.757 -3.698,-14.166 -10.781,-14.166c-7.083,-0 -10.781,5.604 -10.781,14.166c0,8.757 3.698,14.166 10.781,14.166c7.083,0 10.781,-5.604 10.781,-14.166Zm-6.539,0c0,6.538 -1.128,9.496 -4.242,9.496c-2.997,0 -4.242,-2.88 -4.242,-9.496c-0,-6.616 1.206,-9.496 4.242,-9.496c3.036,-0 4.242,2.88 4.242,9.496Zm-29.242,-67c13.246,0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm0.512,9.834c-7.122,-0 -12.609,5.098 -12.609,14.127c-0,9.263 5.215,14.205 12.532,14.205c4.164,0 7.083,-1.634 9.068,-3.658l-2.88,-3.697c-1.518,1.206 -3.153,2.413 -5.838,2.413c-3.697,-0 -6.266,-2.763 -6.266,-9.263c-0,-6.616 2.724,-9.379 6.149,-9.379c2.102,-0 3.892,0.778 5.371,1.984l3.113,-3.775c-2.257,-1.868 -4.748,-2.957 -8.64,-2.957Z"/>
  </g>
</svg></span></a>
    
    <a class="icon-link svg-link" href="https://github.com/commercetools/fs2-queues"><span class="github" title="Source Code"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M49.995,1c-27.609,-0 -49.995,22.386 -49.995,50.002c-0,22.09 14.325,40.83 34.194,47.444c2.501,0.458 3.413,-1.086 3.413,-2.412c0,-1.185 -0.043,-4.331 -0.067,-8.503c-13.908,3.021 -16.843,-6.704 -16.843,-6.704c-2.274,-5.773 -5.552,-7.311 -5.552,-7.311c-4.54,-3.103 0.344,-3.042 0.344,-3.042c5.018,0.356 7.658,5.154 7.658,5.154c4.46,7.64 11.704,5.433 14.552,4.156c0.454,-3.232 1.744,-5.436 3.174,-6.685c-11.102,-1.262 -22.775,-5.553 -22.775,-24.713c-0,-5.457 1.949,-9.92 5.147,-13.416c-0.516,-1.265 -2.231,-6.348 0.488,-13.233c0,0 4.199,-1.344 13.751,5.126c3.988,-1.108 8.266,-1.663 12.518,-1.682c4.245,0.019 8.523,0.574 12.517,1.682c9.546,-6.47 13.736,-5.126 13.736,-5.126c2.728,6.885 1.013,11.968 0.497,13.233c3.204,3.496 5.141,7.959 5.141,13.416c0,19.209 -11.691,23.436 -22.83,24.673c1.795,1.544 3.394,4.595 3.394,9.26c0,6.682 -0.061,12.076 -0.061,13.715c0,1.338 0.899,2.894 3.438,2.406c19.853,-6.627 34.166,-25.354 34.166,-47.438c-0,-27.616 -22.389,-50.002 -50.005,-50.002"/>
  </g>
</svg></span></a>
    
  </div>  

</header>
    
    <nav id="sidebar">

  <div class="row">
    
    <a class="icon-link svg-link" href="https://www.javadoc.io/doc/com.commercetools/fs2-queues-docs_2.13/0.5.0/com/commercetools/queue/index.html"><span class="api" title="API"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M75,47.5c13.246,0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm-50,-0c13.246,-0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,-0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm2.705,16.735l7.239,0l0.622,-4.904l-21.833,0l-0,4.904l7.589,0l0,22.067l6.383,0l-0,-22.067Zm58.076,7.265c-0,-8.757 -3.698,-14.166 -10.781,-14.166c-7.083,-0 -10.781,5.604 -10.781,14.166c0,8.757 3.698,14.166 10.781,14.166c7.083,0 10.781,-5.604 10.781,-14.166Zm-6.539,0c0,6.538 -1.128,9.496 -4.242,9.496c-2.997,0 -4.242,-2.88 -4.242,-9.496c-0,-6.616 1.206,-9.496 4.242,-9.496c3.036,-0 4.242,2.88 4.242,9.496Zm-29.242,-67c13.246,0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm0.512,9.834c-7.122,-0 -12.609,5.098 -12.609,14.127c-0,9.263 5.215,14.205 12.532,14.205c4.164,0 7.083,-1.634 9.068,-3.658l-2.88,-3.697c-1.518,1.206 -3.153,2.413 -5.838,2.413c-3.697,-0 -6.266,-2.763 -6.266,-9.263c-0,-6.616 2.724,-9.379 6.149,-9.379c2.102,-0 3.892,0.778 5.371,1.984l3.113,-3.775c-2.257,-1.868 -4.748,-2.957 -8.64,-2.957Z"/>
  </g>
</svg></span></a>
    
    <a class="icon-link svg-link" href="https://github.com/commercetools/fs2-queues"><span class="github" title="Source Code"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M49.995,1c-27.609,-0 -49.995,22.386 -49.995,50.002c-0,22.09 14.325,40.83 34.194,47.444c2.501,0.458 3.413,-1.086 3.413,-2.412c0,-1.185 -0.043,-4.331 -0.067,-8.503c-13.908,3.021 -16.843,-6.704 -16.843,-6.704c-2.274,-5.773 -5.552,-7.311 -5.552,-7.311c-4.54,-3.103 0.344,-3.042 0.344,-3.042c5.018,0.356 7.658,5.154 7.658,5.154c4.46,7.64 11.704,5.433 14.552,4.156c0.454,-3.232 1.744,-5.436 3.174,-6.685c-11.102,-1.262 -22.775,-5.553 -22.775,-24.713c-0,-5.457 1.949,-9.92 5.147,-13.416c-0.516,-1.265 -2.231,-6.348 0.488,-13.233c0,0 4.199,-1.344 13.751,5.126c3.988,-1.108 8.266,-1.663 12.518,-1.682c4.245,0.019 8.523,0.574 12.517,1.682c9.546,-6.47 13.736,-5.126 13.736,-5.126c2.728,6.885 1.013,11.968 0.497,13.233c3.204,3.496 5.141,7.959 5.141,13.416c0,19.209 -11.691,23.436 -22.83,24.673c1.795,1.544 3.394,4.595 3.394,9.26c0,6.682 -0.061,12.076 -0.061,13.715c0,1.338 0.899,2.894 3.438,2.406c19.853,-6.627 34.166,-25.354 34.166,-47.438c-0,-27.616 -22.389,-50.002 -50.005,-50.002"/>
  </g>
</svg></span></a>
    
  </div>

  <ul class="nav-list">
    <li class="level1 nav-leaf"><a href="../../">Home</a></li>
    <li class="level1 nav-header">Getting Started</li>
    <li class="level2 nav-leaf"><a href="../queues/">Common Queue Interface</a></li>
    <li class="level2 nav-leaf"><a href="../publishing/">Publishing Data</a></li>
    <li class="level2 active nav-leaf"><a href="#">Receiving Data</a></li>
    <li class="level2 nav-leaf"><a href="../stats/">Queue Statistics</a></li>
    <li class="level2 nav-leaf"><a href="../administration/">Managing Queues</a></li>
    <li class="level2 nav-leaf"><a href="../serialization/">Data Serialization</a></li>
    <li class="level2 nav-leaf"><a href="../testing/">Testing</a></li>
    <li class="level1 nav-header">Queue Systems</li>
    <li class="level2 nav-leaf"><a href="../../systems/">Providers</a></li>
    <li class="level2 nav-leaf"><a href="../../systems/sqs/">AWS SQS</a></li>
    <li class="level2 nav-leaf"><a href="../../systems/service-bus/">Azure Service Bus Queues</a></li>
    <li class="level2 nav-leaf"><a href="../../systems/pubsub/">GCP PubSub</a></li>
    <li class="level1 nav-header">Library Integrations</li>
    <li class="level2 nav-leaf"><a href="../../integrations/circe/">Circe</a></li>
    <li class="level2 nav-leaf"><a href="../../integrations/otel4s/">Otel4s</a></li>
  </ul>

</nav>

    <div id="container">

      
<nav id="page-nav">
  <p class="header"><a href="#">Receiving Data</a></p>

  <ul class="nav-list">
    <li class="level1 nav-leaf"><a href="#processors">Processors</a></li>
    <li class="level1 nav-node"><a href="#raw-message-stream">Raw message stream</a></li>
    <li class="level2 nav-leaf"><a href="#messagecontext-control-flow"><code>MessageContext</code> control flow</a></li>
    <li class="level2 nav-leaf"><a href="#messagebatch-control-flow"><code>MessageBatch</code> control flow</a></li>
    <li class="level1 nav-leaf"><a href="#explicit-pull">Explicit pull</a></li>
  </ul>

  <p class="footer"></p>
</nav>



      <main class="content">

        <h1 id="receiving-data" class="title">Receiving Data</h1>
        <p>Receiving data is achieved through a <a class="api" href="https://www.javadoc.io/doc/com.commercetools/fs2-queues-docs_2.13/0.5.0/com/commercetools/queue/QueueSubscriber.html">QueueSubscriber</a>. You can acquire one throuh a <a class="api" href="https://www.javadoc.io/doc/com.commercetools/fs2-queues-docs_2.13/0.5.0/com/commercetools/queue/QueueClient.html">QueueClient</a> by using the <code>subscribe()</code> method. A <code>QueueSubscriber</code> is associated with a specific queue, which is provided when creating the subscriber.</p>
        <p>The subscriber also requires a <a href="../serialization/#data-deserializer">data deserializer</a> upon creation, to deserialize the message payload received from the queue.</p>
        <pre><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="type-name">IO</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">syntax</span><span>.</span><span class="identifier">all</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">scala</span><span>.</span><span class="identifier">concurrent</span><span>.</span><span class="identifier">duration</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">com</span><span>.</span><span class="identifier">commercetools</span><span>.</span><span class="identifier">queue</span><span>.{</span><span class="type-name">Decision</span><span>, </span><span class="type-name">Message</span><span>, </span><span class="type-name">QueueClient</span><span>, </span><span class="type-name">QueueSubscriber</span><span>}
</span><span class="keyword">import</span><span> </span><span class="identifier">com</span><span>.</span><span class="identifier">commercetools</span><span>.</span><span class="identifier">queue</span><span>.</span><span class="type-name">Decision</span><span>.</span><span class="identifier">_</span><span>

</span><span class="keyword">def</span><span> </span><span class="declaration-name">client</span><span>: </span><span class="type-name">QueueClient</span><span>[</span><span class="type-name">IO</span><span>] = ???

</span><span class="keyword">def</span><span> </span><span class="declaration-name">doSomething</span><span>(</span><span class="identifier">message</span><span>: </span><span class="type-name">Message</span><span>[</span><span class="type-name">IO</span><span>, </span><span class="type-name">String</span><span>]): </span><span class="type-name">IO</span><span>[</span><span class="type-name">Unit</span><span>] = </span><span class="type-name">IO</span><span>.</span><span class="identifier">unit</span><span>

</span><span class="keyword">val</span><span> </span><span class="identifier">queueName</span><span>: </span><span class="type-name">String</span><span> = </span><span class="string-literal">&quot;my-queue&quot;</span><span>
</span><span class="comment">// queueName: String = &quot;my-queue&quot;
</span><span>
</span><span class="comment">// returns a subscriber for the queue named `my-queue`,
// which can receive messages of type String
</span><span class="keyword">def</span><span> </span><span class="declaration-name">subscriber</span><span>: </span><span class="type-name">QueueSubscriber</span><span>[</span><span class="type-name">IO</span><span>, </span><span class="type-name">String</span><span>] =
  </span><span class="identifier">client</span><span>.</span><span class="identifier">subscribe</span><span>[</span><span class="type-name">String</span><span>](</span><span class="identifier">queueName</span><span>)</span></code></pre>
        <p>When a message is received by a subscriber, it is <em>locked</em> (or <em>leased</em>) for a queue level configured amount of time (see more on the <a href="../administration/#managing-queues">Managing Queues</a> page). This means that only one subscriber receives (and can process) a given message in this amount of time. A message needs to be settled once processed (or if processing fails) to ensure it is either removed from the queue or made available again. This is part of the message control flow.</p>
        <p>In the following, we explain what kind of control flow handling is provided by the library.</p>
        
        <h2 id="processors" class="section"><a class="anchor-link left" href="#processors"><i class="icofont-laika link">&#xef71;</i></a>Processors</h2>
        <p>The <a class="api" href="https://www.javadoc.io/doc/com.commercetools/fs2-queues-docs_2.13/0.5.0/com/commercetools/queue/QueueSubscriber.html">QueueSubscriber</a> abstraction provides a <code>processWithAutoAck()</code> method, which automatically handles the control flow part for you. You only need to provide the processing function, allowing you to focus on your business logic.</p>
        <div class="callout info">
          <i class="icofont-laika info">&#xef4e;</i>
          <p>The <code>payload</code> is effectful as it performs data deserialization, which can fail when a message payload is malformed.
          You can access the raw data by using <code>rawPayload</code>.</p>
          <p>The deserialized data is memoized so that subsequent accesses to it are not recomputed.</p>
        </div>
        <pre class="keep-together pdf epub"><code class="nohighlight"><span class="identifier">subscriber</span><span>.</span><span class="identifier">processWithAutoAck</span><span>(</span><span class="identifier">batchSize</span><span> = </span><span class="number-literal">10</span><span>, </span><span class="identifier">waitingTime</span><span> = </span><span class="number-literal">20</span><span>.</span><span class="identifier">seconds</span><span>) { </span><span class="identifier">message</span><span> =&gt;
  </span><span class="identifier">message</span><span>.</span><span class="identifier">payload</span><span>.</span><span class="identifier">flatMap</span><span> { </span><span class="identifier">payload</span><span> =&gt;
    </span><span class="type-name">IO</span><span>.</span><span class="identifier">println</span><span>(</span><span class="string-literal">s&quot;Received </span><span class="substitution">$payload</span><span class="string-literal">&quot;</span><span>).</span><span class="identifier">as</span><span>(</span><span class="identifier">message</span><span>.</span><span class="identifier">messageId</span><span>)
  }
}</span></code></pre>
        <p>The processing function receives a <a class="api" href="https://www.javadoc.io/doc/com.commercetools/fs2-queues-docs_2.13/0.5.0/com/commercetools/queue/Message.html">Message</a>, which gives access to the content and some metadata of the received messages.</p>
        <p>The result is a <code>Stream</code> of the processing results, emitted in the order the messages where received. Only the successfully processed messages are emitted down-stream. The stream is failed upon the first failed processing.</p>
        <p>The <code>processWithAutoAck</code> method performs automatic acking/nacking for you depending on the processing outcome. It comes in handy to implement at least once delivery startegies, releasing the message to be reprocessed by another subscriber in case of error.</p>
        <p>If you wish to implement a stream that does not fail upon error, you can use the <code>attemptProcessWithAutoAck()</code> methods, which emits the results of the processing as an <code>Either[Throwable, T]</code>. The resulting stream does not fail if some processing fails. Otherwise it has the same behavior as the stream above.</p>
        <p>For more flexibility in terms of what to do with each received messages, you can also check <code>process()</code> and <code>processWithImmediateDecision()</code>, 
        that will give access to the content and some metadata of the received messages, apply some effects and return a <a class="api" href="https://www.javadoc.io/doc/com.commercetools/fs2-queues-docs_2.13/0.5.0/com/commercetools/queue/Decision.html">Decision</a>, 
        to dictate whether each message should be confirmed (see <a class="api" href="https://www.javadoc.io/doc/com.commercetools/fs2-queues-docs_2.13/0.5.0/com/commercetools/queue/Decision/Ok.html">Ok</a>), dropped (see <a class="api" href="https://www.javadoc.io/doc/com.commercetools/fs2-queues-docs_2.13/0.5.0/com/commercetools/queue/Decision/Drop.html">Drop</a>, 
        considered as failed (see <a class="api" href="https://www.javadoc.io/doc/com.commercetools/fs2-queues-docs_2.13/0.5.0/com/commercetools/queue/Decision/Fail.html">Fail</a>), or if the message should be re-enqueued (see <a class="api" href="https://www.javadoc.io/doc/com.commercetools/fs2-queues-docs_2.13/0.5.0/com/commercetools/queue/Decision/Reenqueue.html">Reenqueue</a>).
        An <a class="api" href="https://www.javadoc.io/doc/com.commercetools/fs2-queues-docs_2.13/0.5.0/com/commercetools/queue/ImmediateDecision.html">ImmediateDecision</a> is a kind of decision that won&#39;t allow messages to get re-enqueued.</p>
        <p>These variants of processors can be as involved as needed, and allow to cover a wide range of use cases, declaratively.</p>
        <pre><code class="nohighlight"><span class="identifier">subscriber</span><span>.</span><span class="identifier">process</span><span>[</span><span class="type-name">Int</span><span>](
  </span><span class="identifier">batchSize</span><span> = </span><span class="number-literal">5</span><span>,
  </span><span class="identifier">waitingTime</span><span> = </span><span class="number-literal">1</span><span>.</span><span class="identifier">second</span><span>,
  </span><span class="identifier">publisherForReenqueue</span><span> = </span><span class="identifier">client</span><span>.</span><span class="identifier">publish</span><span>(</span><span class="identifier">queueName</span><span>))(
  (</span><span class="identifier">msg</span><span>: </span><span class="type-name">Message</span><span>[</span><span class="type-name">IO</span><span>, </span><span class="type-name">String</span><span>]) =&gt;
    (</span><span class="keyword">for</span><span> {
      </span><span class="identifier">payload</span><span> &lt;- </span><span class="identifier">msg</span><span>.</span><span class="identifier">payload</span><span>
      </span><span class="identifier">i</span><span> &lt;- </span><span class="identifier">payload</span><span>.</span><span class="identifier">toIntOption</span><span>.</span><span class="identifier">liftTo</span><span>[</span><span class="type-name">IO</span><span>](</span><span class="keyword">new</span><span> </span><span class="type-name">Exception</span><span>(</span><span class="string-literal">&quot;Payload is not an integer&quot;</span><span>))
      </span><span class="identifier">res</span><span> &lt;- </span><span class="identifier">i</span><span> </span><span class="keyword">match</span><span> {
        </span><span class="comment">// coercing to Int, as an example to show the options
</span><span>        </span><span class="comment">// Checking various scenarios, like a message that gets reenqueue&#39;ed once and then ok&#39;ed,
</span><span>        </span><span class="comment">// a message dropped, a message failed and ack&#39;ed, a message failed and not ack&#39;ed.
</span><span>        </span><span class="comment">// A business logic would do something with the message, effectfully, and dictate what to do with that at the end.
</span><span>        </span><span class="keyword">case</span><span> </span><span class="number-literal">0</span><span> =&gt; </span><span class="identifier">doSomething</span><span>(</span><span class="identifier">msg</span><span>).</span><span class="identifier">as</span><span>(</span><span class="type-name">Decision</span><span>.</span><span class="type-name">Ok</span><span>(</span><span class="number-literal">0</span><span>))
        </span><span class="keyword">case</span><span> </span><span class="number-literal">1</span><span> </span><span class="keyword">if</span><span> </span><span class="identifier">msg</span><span>.</span><span class="identifier">metadata</span><span>.</span><span class="identifier">contains</span><span>(</span><span class="string-literal">&quot;reenqueued&quot;</span><span>) =&gt; </span><span class="identifier">doSomething</span><span>(</span><span class="identifier">msg</span><span>).</span><span class="identifier">as</span><span>(</span><span class="type-name">Decision</span><span>.</span><span class="type-name">Ok</span><span>(</span><span class="number-literal">1</span><span>))
        </span><span class="keyword">case</span><span> </span><span class="number-literal">1</span><span> =&gt; </span><span class="identifier">doSomething</span><span>(</span><span class="identifier">msg</span><span>).</span><span class="identifier">as</span><span>(</span><span class="type-name">Decision</span><span>.</span><span class="type-name">Reenqueue</span><span>(</span><span class="type-name">Map</span><span>(</span><span class="string-literal">&quot;reenqueued&quot;</span><span> -&gt; </span><span class="string-literal">&quot;true&quot;</span><span>).</span><span class="identifier">some</span><span>, </span><span class="type-name">None</span><span>))
        </span><span class="keyword">case</span><span> </span><span class="number-literal">2</span><span> =&gt; </span><span class="identifier">doSomething</span><span>(</span><span class="identifier">msg</span><span>).</span><span class="identifier">as</span><span>(</span><span class="type-name">Decision</span><span>.</span><span class="type-name">Drop</span><span>)
        </span><span class="keyword">case</span><span> </span><span class="number-literal">3</span><span> =&gt; </span><span class="identifier">doSomething</span><span>(</span><span class="identifier">msg</span><span>).</span><span class="identifier">as</span><span>(</span><span class="type-name">Decision</span><span>.</span><span class="type-name">Fail</span><span>(</span><span class="keyword">new</span><span> </span><span class="type-name">Throwable</span><span>(</span><span class="string-literal">&quot;3&quot;</span><span>), </span><span class="identifier">ack</span><span> = </span><span class="boolean-literal">true</span><span>))
        </span><span class="keyword">case</span><span> </span><span class="number-literal">4</span><span> =&gt; </span><span class="identifier">doSomething</span><span>(</span><span class="identifier">msg</span><span>).</span><span class="identifier">as</span><span>(</span><span class="type-name">Decision</span><span>.</span><span class="type-name">Fail</span><span>(</span><span class="keyword">new</span><span> </span><span class="type-name">Throwable</span><span>(</span><span class="string-literal">&quot;4&quot;</span><span>), </span><span class="identifier">ack</span><span> = </span><span class="boolean-literal">false</span><span>))
      }
    } </span><span class="keyword">yield</span><span> </span><span class="identifier">res</span><span>)
    .</span><span class="identifier">handleErrorWith</span><span> { </span><span class="identifier">t</span><span> =&gt;
      </span><span class="comment">// do some logging for instance
</span><span>      </span><span class="type-name">IO</span><span>.</span><span class="identifier">pure</span><span>(</span><span class="type-name">Decision</span><span>.</span><span class="type-name">Fail</span><span>(</span><span class="identifier">t</span><span>, </span><span class="identifier">ack</span><span> = </span><span class="boolean-literal">true</span><span>))
    }
  )</span></code></pre>
        
        <h2 id="raw-message-stream" class="section"><a class="anchor-link left" href="#raw-message-stream"><i class="icofont-laika link">&#xef71;</i></a>Raw message stream</h2>
        <p>If you want more fine-grained tuning of the control flow part, you can resort to the <code>messages()</code> stream available via the <code>QueueSubscriber</code>.
        The stream emits a <a class="api" href="https://www.javadoc.io/doc/com.commercetools/fs2-queues-docs_2.13/0.5.0/com/commercetools/queue/MessageContext.html">MessageContext</a> for each received message, giving access to the message content and metadata, as well as to message control methods.</p>
        <p>Using this stream, you can implement your processing strategy.</p>
        <div class="callout warning">
          <i class="icofont-laika warning">&#xf026;</i>
          <p>Using this stream, you need to explicitly settle the message (either by acking or nacking it) once processed. Failing to do so, results in the message being made available to other subscribers once the lock expires.</p>
          <p>It is up to you to ensure that all control flow paths lead to explicit settlement of the messages you received.</p>
          <p>The recommendation is to only resort to this stream if you need to implement complex custom control flow for messages.</p>
        </div>
        <p>A simplified <code>processWithAutoAck</code> method described above could be implemented this way.</p>
        <div class="callout info">
          <i class="icofont-laika info">&#xef4e;</i>
          <p>The real implementation is more complex to ensure that all successfully processed messages are actually emitted down-stream and is more efficient.</p>
        </div>
        <pre><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="type-name">Outcome</span><span>

</span><span class="keyword">import</span><span> </span><span class="identifier">scala</span><span>.</span><span class="identifier">concurrent</span><span>.</span><span class="identifier">duration</span><span>.</span><span class="identifier">_</span><span>

</span><span class="identifier">subscriber</span><span>
  .</span><span class="identifier">messages</span><span>(</span><span class="identifier">batchSize</span><span> = </span><span class="number-literal">10</span><span>, </span><span class="identifier">waitingTime</span><span> = </span><span class="number-literal">20</span><span>.</span><span class="identifier">seconds</span><span>)
  .</span><span class="identifier">evalMap</span><span> { </span><span class="identifier">context</span><span> =&gt;
    </span><span class="identifier">context</span><span>.</span><span class="identifier">payload</span><span>.</span><span class="identifier">flatMap</span><span> { </span><span class="identifier">payload</span><span> =&gt;
      </span><span class="type-name">IO</span><span>.</span><span class="identifier">println</span><span>(</span><span class="string-literal">s&quot;Received </span><span class="substitution">$payload</span><span class="string-literal">&quot;</span><span>)
        .</span><span class="identifier">as</span><span>(</span><span class="identifier">context</span><span>.</span><span class="identifier">messageId</span><span>)
    }
    .</span><span class="identifier">guaranteeCase</span><span> {
      </span><span class="keyword">case</span><span> </span><span class="type-name">Outcome</span><span>.</span><span class="type-name">Succeeded</span><span>(</span><span class="identifier">_</span><span>) =&gt; </span><span class="identifier">context</span><span>.</span><span class="identifier">ack</span><span>()
      </span><span class="keyword">case</span><span> </span><span class="identifier">_</span><span> =&gt; </span><span class="identifier">context</span><span>.</span><span class="identifier">nack</span><span>()
    }
  }</span></code></pre>
        <p>For high throughput scenarios where acknowledging individual messages wouldn&#39;t be optimal, consider using <code>messageBatches()</code>.</p>
        <p>Batching method exposes <code>MessageBatch</code> giving user control over entire batch as a whole allowing for batched acknowledgement if the implementation supports it.</p>
        <p>Chunked messages can be accessed via <code>messages</code>.</p>
        <pre><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="type-name">Outcome</span><span>

</span><span class="identifier">subscriber</span><span>
  .</span><span class="identifier">messageBatches</span><span>(</span><span class="identifier">batchSize</span><span> = </span><span class="number-literal">10</span><span>, </span><span class="identifier">waitingTime</span><span> = </span><span class="number-literal">20</span><span>.</span><span class="identifier">seconds</span><span>)
  .</span><span class="identifier">evalMap</span><span> { </span><span class="identifier">batch</span><span> =&gt;
    </span><span class="identifier">batch</span><span>.</span><span class="identifier">messages</span><span>.</span><span class="identifier">parTraverse_</span><span> { </span><span class="identifier">msg</span><span> =&gt;
      </span><span class="identifier">msg</span><span>.</span><span class="identifier">payload</span><span>.</span><span class="identifier">flatTap</span><span> { </span><span class="identifier">payload</span><span> =&gt; 
        </span><span class="type-name">IO</span><span>.</span><span class="identifier">println</span><span>(</span><span class="string-literal">s&quot;Received </span><span class="substitution">$payload</span><span class="string-literal">&quot;</span><span>)
      }
    }.</span><span class="identifier">guaranteeCase</span><span> {
      </span><span class="keyword">case</span><span> </span><span class="type-name">Outcome</span><span>.</span><span class="type-name">Succeeded</span><span>(</span><span class="identifier">_</span><span>) =&gt; </span><span class="identifier">batch</span><span>.</span><span class="identifier">ackAll</span><span>.</span><span class="identifier">as</span><span>(())
      </span><span class="keyword">case</span><span> </span><span class="identifier">_</span><span> =&gt; </span><span class="identifier">batch</span><span>.</span><span class="identifier">nackAll</span><span>.</span><span class="identifier">as</span><span>(())
    }
  }</span></code></pre>
        
        <h3 id="messagecontext-control-flow" class="section"><a class="anchor-link left" href="#messagecontext-control-flow"><i class="icofont-laika link">&#xef71;</i></a><code>MessageContext</code> control flow</h3>
        <p>There are three different methods that can be used to control the message lifecycle from the subscriber point of view:</p>
        <ol class="arabic">
          <li><code>MessageContext.ack()</code> acknowledges the message, and marks it as successfully processed in the queue system. It will be permanently removed and no other subscriber will ever receive it.</li>
        </ol>
        <ol class="arabic">
          <li><code>MessageContext.nack()</code> marks the message as not processed, releasing the lock in the queue system. It will be viewable for other subscribers to receive and process.</li>
        </ol>
        <ol class="arabic">
          <li><code>MessageContext.extendLock()</code> extends the currently owned lock by the queue level configured duration. This can be called as many times as you want, as long as you still own the lock. As long as the lock is extended, the message will not be distributed to any other subscriber by the queue system.</li>
        </ol>
        
        <h3 id="messagebatch-control-flow" class="section"><a class="anchor-link left" href="#messagebatch-control-flow"><i class="icofont-laika link">&#xef71;</i></a><code>MessageBatch</code> control flow</h3>
        <p>Methods have the same semantics to <code>MessageContext</code> ones with the difference that they act on all messages from the batch at once. Whether the action is atomic across all messages depends on the underlying implementation.</p>
        <ol class="arabic">
          <li><code>MessageContext.ackAll()</code> acknowledges all the messages from the batch.</li>
          <li><code>MessageContext.nackAll()</code> marks all the messages from the batch as not processed.</li>
        </ol>
        
        <h2 id="explicit-pull" class="section"><a class="anchor-link left" href="#explicit-pull"><i class="icofont-laika link">&#xef71;</i></a>Explicit pull</h2>
        <p>If you are integrating this library with an existing code base that performs explicit pulls from the queue, you can access the <a class="api" href="https://www.javadoc.io/doc/com.commercetools/fs2-queues-docs_2.13/0.5.0/com/commercetools/queue/QueuePuller.html">QueuePuller</a> lower level API, which exposes ways to pull batch of messages.
        This abstraction comes in handy when your processing code is based on a callback approach and is not implemented as a <code>Stream</code>, otherwise you should prefer the streams presented above.</p>
        <p>A <code>QueuePuller</code> is accessed as a <a href="https://typelevel.org/cats-effect/docs/std/resource"><code>Resource</code></a> as it usually implies using a connection pool. When the resource is released, the pools will be disposed properly.</p>
        <pre><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="type-name">Outcome</span><span>

</span><span class="keyword">import</span><span> </span><span class="identifier">scala</span><span>.</span><span class="identifier">concurrent</span><span>.</span><span class="identifier">duration</span><span>.</span><span class="identifier">_</span><span>

</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">syntax</span><span>.</span><span class="identifier">foldable</span><span>.</span><span class="identifier">_</span><span>

</span><span class="identifier">subscriber</span><span>.</span><span class="identifier">puller</span><span>.</span><span class="identifier">use</span><span> { </span><span class="identifier">queuePuller</span><span> =&gt;

  </span><span class="identifier">queuePuller</span><span>
    .</span><span class="identifier">pullBatch</span><span>(</span><span class="identifier">batchSize</span><span> = </span><span class="number-literal">10</span><span>, </span><span class="identifier">waitingTime</span><span> = </span><span class="number-literal">20</span><span>.</span><span class="identifier">seconds</span><span>)
    .</span><span class="identifier">flatMap</span><span> { </span><span class="identifier">chunk</span><span> =&gt;
      </span><span class="identifier">chunk</span><span>.</span><span class="identifier">traverse_</span><span> { </span><span class="identifier">context</span><span> =&gt;
        </span><span class="identifier">context</span><span>.</span><span class="identifier">payload</span><span>.</span><span class="identifier">flatMap</span><span> { </span><span class="identifier">payload</span><span> =&gt;
          </span><span class="type-name">IO</span><span>.</span><span class="identifier">println</span><span>(</span><span class="string-literal">s&quot;Received </span><span class="substitution">$payload</span><span class="string-literal">&quot;</span><span>)
        }.</span><span class="identifier">guaranteeCase</span><span> {
          </span><span class="keyword">case</span><span> </span><span class="type-name">Outcome</span><span>.</span><span class="type-name">Succeeded</span><span>(</span><span class="identifier">_</span><span>) =&gt; </span><span class="identifier">context</span><span>.</span><span class="identifier">ack</span><span>()
          </span><span class="keyword">case</span><span> </span><span class="identifier">_</span><span> =&gt; </span><span class="identifier">context</span><span>.</span><span class="identifier">nack</span><span>()
        }
      }
    }
}</span></code></pre>
        <div class="callout warning">
          <i class="icofont-laika warning">&#xf026;</i>
          <p>Make sure that <code>IO</code>s pulling from the <code>queuePuller</code> do not outlive the <code>use</code> scope, otherwise you will be using a closed resource after the <code>use</code> block returns.
          If you need to spawn background fibers using the <code>queuePuller</code>, you can for instance use a <a href="https://typelevel.org/cats-effect/docs/std/supervisor"><code>Supervisor</code></a> whose lifetime is nested within the <code>queuePuller</code> one.</p>
          <pre><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="type-name">Outcome</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="identifier">std</span><span>.</span><span class="type-name">Supervisor</span><span>

</span><span class="keyword">import</span><span> </span><span class="identifier">scala</span><span>.</span><span class="identifier">concurrent</span><span>.</span><span class="identifier">duration</span><span>.</span><span class="identifier">_</span><span>

</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">syntax</span><span>.</span><span class="identifier">foldable</span><span>.</span><span class="identifier">_</span><span>

</span><span class="identifier">subscriber</span><span>.</span><span class="identifier">puller</span><span>.</span><span class="identifier">use</span><span> { </span><span class="identifier">queuePuller</span><span> =&gt;
  </span><span class="comment">// create a supervisor that waits for supervised spawn fibers
</span><span>  </span><span class="comment">// to finish before being released
</span><span>  </span><span class="type-name">Supervisor</span><span>[</span><span class="type-name">IO</span><span>](</span><span class="identifier">await</span><span> = </span><span class="boolean-literal">true</span><span>).</span><span class="identifier">use</span><span> { </span><span class="identifier">supervisor</span><span> =&gt;
    </span><span class="identifier">queuePuller</span><span>
      .</span><span class="identifier">pullBatch</span><span>(</span><span class="identifier">batchSize</span><span> = </span><span class="number-literal">10</span><span>, </span><span class="identifier">waitingTime</span><span> = </span><span class="number-literal">20</span><span>.</span><span class="identifier">seconds</span><span>)
      .</span><span class="identifier">flatMap</span><span> { </span><span class="identifier">chunk</span><span> =&gt;
        </span><span class="identifier">chunk</span><span>.</span><span class="identifier">traverse_</span><span> { </span><span class="identifier">context</span><span> =&gt;
          </span><span class="identifier">supervisor</span><span>.</span><span class="identifier">supervise</span><span> {
            </span><span class="identifier">context</span><span>.</span><span class="identifier">payload</span><span>.</span><span class="identifier">flatMap</span><span> { </span><span class="identifier">payload</span><span> =&gt;
              </span><span class="type-name">IO</span><span>.</span><span class="identifier">println</span><span>(</span><span class="string-literal">s&quot;Received </span><span class="substitution">$payload</span><span class="string-literal">&quot;</span><span>)
            }
            .</span><span class="identifier">guaranteeCase</span><span> {
              </span><span class="keyword">case</span><span> </span><span class="type-name">Outcome</span><span>.</span><span class="type-name">Succeeded</span><span>(</span><span class="identifier">_</span><span>) =&gt; </span><span class="identifier">context</span><span>.</span><span class="identifier">ack</span><span>()
              </span><span class="keyword">case</span><span> </span><span class="identifier">_</span><span> =&gt; </span><span class="identifier">context</span><span>.</span><span class="identifier">nack</span><span>()
            }
          }
        }
      }
  }
}</span></code></pre>
        </div>
        <p>To pull batches that can be acknowledged in batches, use <code>pullMessageBatch()</code></p>
        <pre><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="type-name">Outcome</span><span>

</span><span class="identifier">subscriber</span><span>.</span><span class="identifier">puller</span><span>.</span><span class="identifier">use</span><span> { </span><span class="identifier">queuePuller</span><span> =&gt;

  </span><span class="identifier">queuePuller</span><span>
    .</span><span class="identifier">pullMessageBatch</span><span>(</span><span class="identifier">batchSize</span><span> = </span><span class="number-literal">10</span><span>, </span><span class="identifier">waitingTime</span><span> = </span><span class="number-literal">20</span><span>.</span><span class="identifier">seconds</span><span>)
    .</span><span class="identifier">flatMap</span><span> { </span><span class="identifier">batch</span><span> =&gt;
      </span><span class="identifier">batch</span><span>.</span><span class="identifier">messages</span><span>.</span><span class="identifier">traverse_</span><span> { </span><span class="identifier">message</span><span> =&gt;
        </span><span class="identifier">message</span><span>.</span><span class="identifier">payload</span><span>.</span><span class="identifier">flatMap</span><span> { </span><span class="identifier">payload</span><span> =&gt;
          </span><span class="type-name">IO</span><span>.</span><span class="identifier">println</span><span>(</span><span class="string-literal">s&quot;Received </span><span class="substitution">$payload</span><span class="string-literal">&quot;</span><span>)
        }.</span><span class="identifier">guaranteeCase</span><span> {
          </span><span class="keyword">case</span><span> </span><span class="type-name">Outcome</span><span>.</span><span class="type-name">Succeeded</span><span>(</span><span class="identifier">_</span><span>) =&gt; </span><span class="identifier">batch</span><span>.</span><span class="identifier">ackAll</span><span>.</span><span class="identifier">as</span><span>(())
          </span><span class="keyword">case</span><span> </span><span class="identifier">_</span><span> =&gt; </span><span class="identifier">batch</span><span>.</span><span class="identifier">nackAll</span><span>.</span><span class="identifier">as</span><span>(())
        }
      }
    }
  
}</span></code></pre>

        
<hr class="footer-rule"/>
<footer>
  Copyright &copy; <a href="https://commercetools.com/">commercetools</a>
</footer>


      </main>

    </div>

  </body>

</html>